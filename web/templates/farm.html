{% extends "base.html" %}

{% block title %}å¼€å¿ƒå†œåœº{% endblock %}

{% block extra_head %}
<style>
.farm-container {
    min-height: 100vh;
    background: linear-gradient(135deg, #a8e6cf 0%, #dcedc8 50%, #f1f8e9 100%);
    padding: 2rem 0;
}

.farm-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin: 2rem 0;
}

.farm-slot {
    aspect-ratio: 1;
    border: 3px dashed #8bc34a;
    border-radius: 15px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: #f8f9fa;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    min-height: 150px;
}

.farm-slot:hover {
    border-color: #4caf50;
    background: #e8f5e8;
    transform: translateY(-2px);
}

.farm-slot.occupied {
    border-style: solid;
    background: #e8f5e8;
    cursor: default;
}

.farm-slot.growing {
    border-color: #4caf50;
}

.farm-slot.mature {
    border-color: #ff9800;
    background: #fff3e0;
}

.farm-slot.dead {
    border-color: #f44336;
    background: #ffebee;
}

.crop-info {
    text-align: center;
    padding: 0.5rem;
}

.crop-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.crop-name {
    font-weight: bold;
    margin-bottom: 0.25rem;
}

.crop-status {
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
    border-radius: 15px;
    color: white;
}

.crop-status.growing {
    background: #4caf50;
}

.crop-status.mature {
    background: #ff9800;
}

.crop-status.dead {
    background: #f44336;
}

.seed-shop {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.seed-item {
    border: 1px solid #ddd;
    border-radius: 10px;
    padding: 1rem;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
}

.seed-item:hover {
    border-color: #4caf50;
    box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);
}

.seed-icon {
    font-size: 1.5rem;
    margin-right: 0.5rem;
}

.inventory-section {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.inventory-item {
    display: flex;
    align-items: center;
    padding: 0.5rem;
    border-bottom: 1px solid #eee;
}

.action-buttons {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.balance-display {
    background: linear-gradient(135deg, #4caf50, #8bc34a);
    color: white;
    border-radius: 15px;
    padding: 1rem;
    text-align: center;
    margin-bottom: 2rem;
}

.empty-slot-icon {
    font-size: 2rem;
    color: #ccc;
    margin-bottom: 0.5rem;
}

.empty-slot-text {
    color: #666;
    font-size: 0.9rem;
}

@media (max-width: 768px) {
    .farm-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .farm-slot {
        min-height: 120px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="farm-container">
    <div class="container">
        <!-- ä½™é¢æ˜¾ç¤º -->
        <div class="balance-display">
            <h4 class="mb-0">
                <i class="fas fa-coins me-2"></i>
                <span id="userBalance">{{ balance }}</span> å®å®å¸
            </h4>
        </div>

        <!-- å†œåœºæ ‡é¢˜ -->
        <div class="text-center mb-4">
            <h1 class="text-success">
                <i class="fas fa-seedling me-2"></i>
                å¼€å¿ƒå†œåœº
            </h1>
            <p class="text-muted">ç§æ¤ã€æµ‡æ°´ã€æ”¶è·ï¼Œä½“éªŒå†œåœºä¹è¶£</p>
        </div>

        <!-- ç§å­å•†åº— -->
        <div class="seed-shop">
            <h3 class="text-success mb-3">
                <i class="fas fa-store me-2"></i>
                ç§å­å•†åº—
            </h3>
            <div class="row">
                {% for seed_id, seed in seeds.items() %}
                {% if seed.available %}
                <div class="col-md-6 mb-3">
                    <div class="seed-item">
                        <div class="d-flex align-items-center mb-2">
                            <span class="seed-icon">{{ seed.icon }}</span>
                            <div class="flex-grow-1">
                                <h5 class="mb-1">{{ seed.name }}</h5>
                                <p class="text-muted mb-1">{{ seed.description }}</p>
                                <small class="text-info">æµ‡æ°´ {{ seed.required_water_count }} æ¬¡æˆç†Ÿ</small>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="h5 text-success mb-0">{{ seed.price }} å®å®å¸</span>
                            <button class="btn btn-success" onclick="buySeed('{{ seed_id }}', '{{ seed.name }}', {{ seed.price }})">
                                <i class="fas fa-shopping-cart me-1"></i>è´­ä¹°
                            </button>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- ç§å­åº“å­˜ -->
        <div class="inventory-section">
            <h3 class="text-primary mb-3">
                <i class="fas fa-warehouse me-2"></i>
                ç§å­åº“å­˜
            </h3>
            <div id="seedInventory">
                {% if farm_data.seeds_inventory %}
                    {% for seed_id, quantity in farm_data.seeds_inventory.items() %}
                    <div class="inventory-item">
                        <span class="seed-icon">{{ seeds[seed_id].icon }}</span>
                        <div class="flex-grow-1">
                            <strong>{{ seeds[seed_id].name }}</strong>
                            <span class="text-muted ms-2">x{{ quantity }}</span>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">æš‚æ— ç§å­åº“å­˜ï¼Œå»å•†åº—è´­ä¹°ä¸€äº›ç§å­å§ï¼</p>
                {% endif %}
            </div>
        </div>

        <!-- ç²ªä¾¿åº“å­˜ -->
        <div class="inventory-section">
            <h3 class="text-warning mb-3">
                <i class="fas fa-mountain me-2"></i>
                ç²ªä¾¿åº“å­˜
            </h3>
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <span class="fs-4">ğŸ’©</span>
                    <span class="ms-2">ç²ªä¾¿ï¼š<strong id="fertilizerCount">{{ farm_data.fertilizer }}</strong> ä¸ª</span>
                </div>
                <div>
                    <button class="btn btn-warning btn-sm" onclick="buyFertilizer()">
                        <i class="fas fa-shopping-cart me-1"></i>
                        è´­ä¹°ç²ªä¾¿ (88å®å®å¸/ä¸ª)
                    </button>
                </div>
            </div>
            
            <!-- å†œåœºæ‰“å¡åŠŸèƒ½ -->
            <div class="border-top pt-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="text-muted">ä»Šæ—¥å†œåœºæ‰“å¡ï¼š<strong id="dailyPoopCount">{{ farm_data.daily_poop_count|default(0) }}</strong>/3 æ¬¡</span>
                    </div>
                    <div>
                        <button class="btn btn-success btn-sm" onclick="farmPoop()">
                            <i class="fas fa-toilet me-1"></i>
                            å†œåœºæ‰“å¡ (å…è´¹è·å¾—ç²ªä¾¿)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- å†œåœºç§æ¤åŒº -->
        <div class="text-center mb-3">
            <h3 class="text-success">
                <i class="fas fa-leaf me-2"></i>
                ç§æ¤åŒºåŸŸ
            </h3>
            <p class="text-muted">ç‚¹å‡»ç©ºåœ°æ’­ç§ï¼Œç‚¹å‡»ä½œç‰©è¿›è¡Œæ“ä½œ</p>
        </div>

        <div class="farm-grid" id="farmGrid">
            {% for i in range(farm_data.farm_slots) %}
            <div class="farm-slot" data-slot="{{ i }}" onclick="handleSlotClick({{ i }})">
                {% set crop = farm_data.planted_crops | selectattr('slot_index', 'equalto', i) | first %}
                {% if crop %}
                    <div class="crop-info">
                        <div class="crop-icon">{{ seeds[crop.seed_id].icon }}</div>
                        <div class="crop-name">{{ seeds[crop.seed_id].name }}</div>
                        <div class="crop-status {{ crop.status }}">
                            {% if crop.status == 'growing' %}
                                ç”Ÿé•¿ä¸­ ({{ crop.water_count }}/{{ seeds[crop.seed_id].required_water_count }}æ°´, {{ crop.fertilizer_count|default(0) }}/{{ seeds[crop.seed_id].required_fertilizer_count }}è‚¥)
                                <br>
                                {% set current_date = moment().strftime('%Y-%m-%d') if moment else none %}
                                <small class="text-muted">
                                    æµ‡æ°´ï¼š<span id="water-status-{{ crop.id }}">æ£€æŸ¥ä¸­...</span> | 
                                    æ–½è‚¥ï¼š<span id="fertilizer-status-{{ crop.id }}">æ£€æŸ¥ä¸­...</span>
                                </small>
                            {% elif crop.status == 'mature' %}
                                å·²æˆç†Ÿ
                            {% elif crop.status == 'dead' %}
                                å·²æ­»äº¡
                            {% endif %}
                        </div>
                        <div class="action-buttons">
                            {% if crop.status == 'growing' %}
                                <button class="btn btn-primary btn-sm" 
                                        onclick="event.stopPropagation(); waterCrop('{{ crop.id }}')"
                                        id="water-btn-{{ crop.id }}">
                                    <i class="fas fa-tint me-1"></i>æµ‡æ°´ (52å¸)
                                </button>
                                <button class="btn btn-warning btn-sm" 
                                        onclick="event.stopPropagation(); fertilizeCrop('{{ crop.id }}')"
                                        id="fertilizer-btn-{{ crop.id }}">
                                    <i class="fas fa-mountain me-1"></i>æ–½è‚¥ (1ç²ªä¾¿)
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); shovelCrop('{{ crop.id }}')">
                                    <i class="fas fa-tools me-1"></i>é“é“²
                                </button>
                            {% elif crop.status == 'mature' %}
                                <button class="btn btn-warning btn-sm" onclick="event.stopPropagation(); harvestCrop('{{ crop.id }}')">
                                    <i class="fas fa-hand-paper me-1"></i>æ”¶è·
                                </button>
                            {% elif crop.status == 'dead' %}
                                <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); removeDeadCrop('{{ crop.id }}')">
                                    <i class="fas fa-trash me-1"></i>æ¸…ç†
                                </button>
                            {% endif %}
                        </div>
                    </div>
                {% else %}
                    <div class="empty-slot-icon">ğŸŒ±</div>
                    <div class="empty-slot-text">ç‚¹å‡»æ’­ç§</div>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <!-- è¿”å›æŒ‰é’® -->
        <div class="text-center mt-4">
            <a href="{{ url_for('daily_tasks') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>è¿”å›ä»»åŠ¡ä¸­å¿ƒ
            </a>
        </div>
    </div>
</div>

<!-- æ’­ç§æ¨¡æ€æ¡† -->
<div class="modal fade" id="plantModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-seedling me-2"></i>é€‰æ‹©ç§å­
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="plantModalBody">
                <!-- åŠ¨æ€å†…å®¹ -->
            </div>
        </div>
    </div>
</div>

<script>
let currentBalance = {{ balance }};
let selectedSlot = null;
let seedsInventory = {{ farm_data.seeds_inventory | tojson }};
let seedsData = {{ seeds | tojson }};
let farmData = {{ farm_data | tojson }};

// åˆå§‹åŒ–é¡µé¢ï¼Œæ£€æŸ¥æ¯æ—¥æ“ä½œçŠ¶æ€
document.addEventListener('DOMContentLoaded', function() {
    checkDailyOperationStatus();
});

function checkDailyOperationStatus() {
    const today = new Date().toISOString().split('T')[0]; // è·å–ä»Šå¤©çš„æ—¥æœŸ YYYY-MM-DD
    
    farmData.planted_crops.forEach(crop => {
        if (crop.status === 'growing') {
            // æ£€æŸ¥æµ‡æ°´çŠ¶æ€
            const waterStatusEl = document.getElementById(`water-status-${crop.id}`);
            const waterBtnEl = document.getElementById(`water-btn-${crop.id}`);
            
            if (crop.last_watered === today) {
                if (waterStatusEl) waterStatusEl.textContent = 'ä»Šæ—¥å·²æµ‡';
                if (waterBtnEl) {
                    waterBtnEl.disabled = true;
                    waterBtnEl.classList.add('disabled');
                    waterBtnEl.title = 'ä»Šæ—¥å·²æµ‡æ°´';
                }
            } else {
                if (waterStatusEl) waterStatusEl.textContent = 'å¯æµ‡æ°´';
            }
            
            // æ£€æŸ¥æ–½è‚¥çŠ¶æ€
            const fertilizerStatusEl = document.getElementById(`fertilizer-status-${crop.id}`);
            const fertilizerBtnEl = document.getElementById(`fertilizer-btn-${crop.id}`);
            
            if (crop.last_fertilized === today) {
                if (fertilizerStatusEl) fertilizerStatusEl.textContent = 'ä»Šæ—¥å·²æ–½';
                if (fertilizerBtnEl) {
                    fertilizerBtnEl.disabled = true;
                    fertilizerBtnEl.classList.add('disabled');
                    fertilizerBtnEl.title = 'ä»Šæ—¥å·²æ–½è‚¥';
                }
            } else {
                if (fertilizerStatusEl) fertilizerStatusEl.textContent = 'å¯æ–½è‚¥';
            }
        }
    });
}

function buySeed(seedId, seedName, price) {
    if (currentBalance < price) {
        showToast(`å®å®å¸ä¸è¶³ï¼éœ€è¦${price}ä¸ªå®å®å¸è´­ä¹°${seedName}`, 'error');
        return;
    }
    
    if (!confirm(`ç¡®å®šè¦èŠ±è´¹${price}ä¸ªå®å®å¸è´­ä¹°${seedName}å—ï¼Ÿ`)) {
        return;
    }
    
    fetch('/buy_seed', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            seed_id: seedId,
            quantity: 1
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentBalance = data.new_balance;
            document.getElementById('userBalance').textContent = currentBalance;
            showToast(data.message, 'success');
            
            // æ›´æ–°ç§å­åº“å­˜æ˜¾ç¤º
            updateSeedInventory(data.seeds_inventory);
        } else {
            showToast(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('è´­ä¹°å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    });
}

function handleSlotClick(slotIndex) {
    const slot = document.querySelector(`[data-slot="${slotIndex}"]`);
    
    // æ£€æŸ¥è¯¥ä½ç½®æ˜¯å¦å·²ç»æœ‰ä½œç‰©
    const hasCrop = slot.querySelector('.crop-info') !== null;
    
    if (hasCrop) {
        return; // å·²å ç”¨çš„ä½ç½®ä¸å¤„ç†
    }
    
    selectedSlot = slotIndex;
    showPlantModal();
}

function showPlantModal() {
    // æ˜¾ç¤ºæ’­ç§æ¨¡æ€æ¡†
    const modalBody = document.getElementById('plantModalBody');
    
    let modalContent = '<div class="row">';
    
    // æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨çš„ç§å­
    let hasSeeds = false;
    for (let seedId in seedsInventory) {
        if (seedsInventory[seedId] > 0) {
            hasSeeds = true;
            const seed = seedsData[seedId];
            modalContent += `
                <div class="col-md-6 mb-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <div class="h1">${seed.icon}</div>
                            <h6 class="card-title">${seed.name}</h6>
                            <p class="text-muted small">${seed.description}</p>
                            <div class="badge bg-info mb-2">åº“å­˜: ${seedsInventory[seedId]}ä¸ª</div>
                            <br>
                            <button class="btn btn-success btn-sm" onclick="plantSeed('${seedId}', '${seed.name}')">
                                <i class="fas fa-seedling me-1"></i>ç§æ¤
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
    }
    
    if (!hasSeeds) {
        modalContent = '<div class="text-center"><p class="text-muted">æš‚æ— å¯ç”¨ç§å­ï¼Œè¯·å…ˆåˆ°å•†åº—è´­ä¹°ç§å­</p></div>';
    }
    
    modalContent += '</div>';
    modalBody.innerHTML = modalContent;
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    const modal = new bootstrap.Modal(document.getElementById('plantModal'));
    modal.show();
}

function plantSeed(seedId, seedName) {
    if (selectedSlot === null) {
        showToast('è¯·å…ˆé€‰æ‹©ç§æ¤ä½ç½®', 'error');
        return;
    }
    
    fetch('/plant_seed', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            seed_id: seedId,
            slot_index: selectedSlot
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            
            // æ›´æ–°ç§å­åº“å­˜
            if (data.seeds_inventory) {
                seedsInventory = data.seeds_inventory;
            }
            
            // å…³é—­æ¨¡æ€æ¡†
            const modal = bootstrap.Modal.getInstance(document.getElementById('plantModal'));
            if (modal) {
                modal.hide();
            }
            
            // é‡ç½®é€‰ä¸­çš„ä½ç½®
            selectedSlot = null;
            
            // åˆ·æ–°é¡µé¢æ˜¾ç¤ºæœ€æ–°çŠ¶æ€
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('æ’­ç§å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    });
}

function waterCrop(cropId) {
    if (currentBalance < 52) {
        showToast('å®å®å¸ä¸è¶³ï¼æµ‡æ°´éœ€è¦52ä¸ªå®å®å¸', 'error');
        return;
    }
    
    if (!confirm('ç¡®å®šè¦èŠ±è´¹52ä¸ªå®å®å¸æµ‡æ°´å—ï¼Ÿ')) {
        return;
    }
    
    fetch('/water_crop', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            crop_id: cropId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentBalance = data.new_balance;
            document.getElementById('userBalance').textContent = currentBalance;
            showToast(data.message, 'success');
            
            // åˆ·æ–°é¡µé¢æ˜¾ç¤ºæœ€æ–°çŠ¶æ€
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('æµ‡æ°´å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    });
}

function harvestCrop(cropId) {
    fetch('/harvest_crop', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            crop_id: cropId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            
            // åˆ·æ–°é¡µé¢æ˜¾ç¤ºæœ€æ–°çŠ¶æ€
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('æ”¶è·å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    });
}

function removeDeadCrop(cropId) {
    if (!confirm('ç¡®å®šè¦æ¸…ç†è¿™ä¸ªæ­»äº¡çš„ä½œç‰©å—ï¼Ÿ')) {
        return;
    }
    
    fetch('/remove_dead_crop', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            crop_id: cropId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            
            // åˆ·æ–°é¡µé¢æ˜¾ç¤ºæœ€æ–°çŠ¶æ€
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('æ¸…ç†å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    });
}

function updateSeedInventory(seedsInventory) {
    // æ›´æ–°ç§å­åº“å­˜æ˜¾ç¤º
    const inventoryDiv = document.getElementById('seedInventory');
    if (Object.keys(seedsInventory).length === 0) {
        inventoryDiv.innerHTML = '<p class="text-muted">æš‚æ— ç§å­åº“å­˜ï¼Œå»å•†åº—è´­ä¹°ä¸€äº›ç§å­å§ï¼</p>';
    } else {
        // è¿™é‡Œå¯ä»¥åŠ¨æ€æ›´æ–°åº“å­˜ï¼Œæš‚æ—¶é€‰æ‹©åˆ·æ–°é¡µé¢
        setTimeout(() => location.reload(), 1500);
    }
}

function buyFertilizer() {
    const price = 88;
    if (currentBalance < price) {
        showToast(`å®å®å¸ä¸è¶³ï¼éœ€è¦${price}ä¸ªå®å®å¸è´­ä¹°ç²ªä¾¿`, 'error');
        return;
    }
    
    if (!confirm(`ç¡®å®šè¦èŠ±è´¹${price}ä¸ªå®å®å¸è´­ä¹°1ä¸ªç²ªä¾¿å—ï¼Ÿ`)) {
        return;
    }
    
    fetch('/buy_fertilizer', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            quantity: 1
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentBalance = data.new_balance;
            document.getElementById('userBalance').textContent = currentBalance;
            document.getElementById('fertilizerCount').textContent = data.fertilizer;
            showToast(data.message, 'success');
        } else {
            showToast(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('è´­ä¹°å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    });
}

function shovelCrop(cropId) {
    if (!confirm('ç¡®å®šè¦é“²é™¤è¿™ä¸ªä½œç‰©å—ï¼Ÿé“²é™¤åæ— æ³•æ¢å¤ï¼')) {
        return;
    }
    
    fetch('/shovel_crop', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            crop_id: cropId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            // åˆ·æ–°é¡µé¢æ˜¾ç¤ºæœ€æ–°çŠ¶æ€
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('é“²é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    });
}

function fertilizeCrop(cropId) {
    fetch('/fertilize_crop', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            crop_id: cropId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('fertilizerCount').textContent = data.fertilizer;
            showToast(data.message, 'success');
            // åˆ·æ–°é¡µé¢æ¥æ›´æ–°ä½œç‰©çŠ¶æ€
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('æ–½è‚¥å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    });
}

function farmPoop() {
    fetch('/farm_poop', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('fertilizerCount').textContent = data.fertilizer;
            document.getElementById('dailyPoopCount').textContent = data.daily_poop_count;
            showToast(data.message, 'success');
        } else {
            showToast(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('å†œåœºæ‰“å¡å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    });
}

function showToast(message, type = 'info') {
    // ç®€å•çš„æç¤ºå®ç°
    alert(message);
}
</script>
{% endblock %}