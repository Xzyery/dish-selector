{% extends "base.html" %}

{% block title %}客户点餐端 - WXZY点餐系统{% endblock %}

{% block content %}
<div class="customer-dashboard">
    <div class="container-fluid">
        <!-- 页面标题 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center flex-wrap">
                    <h1 class="display-6 mb-2 text-dark">
                        <i class="fas fa-utensils text-primary me-3"></i>
                        WXZY菜单
                    </h1>
                    <div class="customer-actions">
                        <!-- 宝宝币余额显示 -->
                        <div class="balance-display me-3">
                            <button class="badge bg-warning text-dark fs-6 border-0" data-bs-toggle="modal" data-bs-target="#transactionModal" style="cursor: pointer;">
                                <i class="fas fa-coins me-1"></i>
                                <span id="userBalance">{{ user_data.balance or 0 }}</span> 宝宝币
                            </button>
                        </div>
                        
                        <!-- 任务中心按钮 -->
                        <a href="/daily_tasks" class="btn btn-info me-2">
                            <i class="fas fa-tasks me-2"></i>任务中心
                        </a>
                        
                        <button class="btn btn-warning" onclick="randomRecommend()">
                            <i class="fas fa-random me-2"></i>随机推荐
                        </button>
                        <button class="btn btn-outline-danger ms-2" onclick="clearCart()">
                            <i class="fas fa-trash me-2"></i>清空购物车
                        </button>
                        <button class="btn btn-success ms-2" data-bs-toggle="modal" data-bs-target="#orderModal">
                            <i class="fas fa-shopping-cart me-2"></i>
                            确认下单 (<span id="cartCount">0</span>)
                        </button>
                    </div>
                </div>
                {% if customer_id %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    您的客户ID: <strong>{{ customer_id }}</strong> - 厨师可以通过此ID识别您的订单
                </div>
                {% endif %}
            </div>
        </div>

        <div class="row">
            <!-- 左侧：菜品展示 -->
            <div class="col-lg-8">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-list me-2"></i>
                            精选菜品 ({{ dishes|length }} 道菜)
                        </h4>
                    </div>
                    <div class="card-body">
                        {% if dishes %}
                            <div class="dishes-gallery">
                                {% for dish in dishes %}
                                <div class="dish-card mb-4" data-dish-index="{{ loop.index0 }}" data-dish-name="{{ dish.name }}">
                                    <div class="card h-100 border-0 shadow-sm dish-item-hover">
                                        <div class="position-relative">
                                            <img src="{{ url_for('uploaded_file', filename=dish.image_path.split('/')[-1]) }}" 
                                                 class="card-img-top dish-image" 
                                                 alt="{{ dish.name }}"
                                                 style="height: 250px; object-fit: cover;">
                                            <div class="dish-overlay">
                                                <div class="price-badge">
                                                    <span class="badge bg-warning text-dark">
                                                        <i class="fas fa-coins me-1"></i>
                                                        {{ dish.price or 52 }} 宝宝币
                                                    </span>
                                                </div>
                                                <button class="btn btn-primary btn-lg" onclick="addToCart('{{ dish.name|e }}', {{ loop.index0 }}, {{ dish.price or 52 }})">
                                                    <i class="fas fa-plus me-2"></i>加入购物车
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body text-center">
                                            <h5 class="card-title">{{ dish.name }}</h5>
                                            <p class="card-text text-muted">
                                                <small>编号: {{ loop.index }}</small>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="empty-menu text-center py-5">
                                <i class="fas fa-plate-wheat text-muted" style="font-size: 4rem;"></i>
                                <h4 class="mt-3 text-muted">暂无菜品</h4>
                                <p class="text-muted">菜单正在准备中，请稍后再来查看</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- 右侧：购物车 -->
            <div class="col-lg-4">
                <div class="card shadow-sm sticky-top" style="top: 20px;">
                    <div class="card-header bg-success text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-shopping-cart me-2"></i>
                            购物车
                        </h4>
                    </div>
                    <div class="card-body">
                        <div id="cartItems">
                            <div class="empty-cart text-center py-4">
                                <i class="fas fa-shopping-cart text-muted" style="font-size: 2rem;"></i>
                                <p class="mt-2 text-muted">购物车为空<br>选择您喜欢的菜品吧！</p>
                            </div>
                        </div>
                        
                        <div id="cartSummary" style="display: none;" class="mt-3 pt-3 border-top">
                            <div class="d-flex justify-content-between">
                                <span>总菜品数：</span>
                                <span id="totalItems">0</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>不同菜品：</span>
                                <span id="uniqueItems">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <button class="btn btn-success w-100" data-bs-toggle="modal" data-bs-target="#orderModal" id="checkoutBtn" disabled>
                            <i class="fas fa-check me-2"></i>确认下单
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 下单确认模态框 -->
<div class="modal fade" id="orderModal" tabindex="-1" aria-labelledby="orderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="orderModalLabel">
                    <i class="fas fa-check-circle me-2"></i>确认下单
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="customerName" class="form-label">
                        <i class="fas fa-user me-1"></i>您的姓名
                    </label>
                    <input type="text" class="form-control" id="customerName" placeholder="请输入您的姓名（可选）">
                    <div class="form-text">方便厨师识别您的订单</div>
                </div>
                
                <div class="mb-3">
                    <h6><i class="fas fa-list me-2"></i>订单详情：</h6>
                    <div id="orderSummary" class="border rounded p-3 bg-light">
                        <!-- 订单详情将通过JavaScript填充 -->
                    </div>
                </div>
                
                <!-- 优惠券选择区域 -->
                <div class="mb-3" id="couponSection">
                    <h6><i class="fas fa-ticket-alt me-2"></i>可用优惠券：</h6>
                    <div id="couponList" class="border rounded p-3 bg-light">
                        <!-- 优惠券列表将通过JavaScript填充 -->
                        <div class="text-center text-muted">
                            <i class="fas fa-spinner fa-spin me-2"></i>加载优惠券中...
                        </div>
                    </div>
                    <div class="form-text">选择优惠券可以享受折扣或免费用餐</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>取消
                </button>
                <button type="button" class="btn btn-success" onclick="submitOrder()">
                    <i class="fas fa-paper-plane me-1"></i>提交订单
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 成功提示模态框 -->
<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="successModalLabel">
                    <i class="fas fa-check-circle me-2"></i>订单提交成功
                </h5>
            </div>
            <div class="modal-body text-center">
                <i class="fas fa-check-circle text-success" style="font-size: 3rem;"></i>
                <h4 class="mt-3">订单已提交！</h4>
                <p class="text-muted">您的订单已成功提交给厨师，请耐心等待美味出炉！</p>
                <div id="orderIdDisplay" class="mt-3 p-3 bg-light rounded">
                    <!-- 订单ID将显示在这里 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" data-bs-dismiss="modal" onclick="location.reload()">
                    <i class="fas fa-utensils me-1"></i>继续点餐
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 交易详情模态框 -->
<div class="modal fade" id="transactionModal" tabindex="-1" aria-labelledby="transactionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="transactionModalLabel">
                    <i class="fas fa-coins me-2"></i>宝宝币交易记录
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- 余额概览 -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h5 class="card-title">
                                    <i class="fas fa-wallet me-1"></i>当前余额
                                </h5>
                                <h3 class="mb-0">{{ user_data.balance or 0 }} 币</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <h5 class="card-title">
                                    <i class="fas fa-arrow-up me-1"></i>总收入
                                </h5>
                                <h3 class="mb-0" id="totalIncome">0 币</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-danger text-white">
                            <div class="card-body text-center">
                                <h5 class="card-title">
                                    <i class="fas fa-arrow-down me-1"></i>总支出
                                </h5>
                                <h3 class="mb-0" id="totalExpense">0 币</h3>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 交易记录列表 -->
                <div class="transaction-list">
                    <h6 class="mb-3">
                        <i class="fas fa-history me-1"></i>最近交易记录
                    </h6>
                    {% if user_data.transactions %}
                        <div class="list-group">
                            {% for transaction in user_data.transactions[:20] %}
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center">
                                            {% if transaction.amount > 0 %}
                                                <i class="fas fa-plus-circle text-success me-2"></i>
                                            {% else %}
                                                <i class="fas fa-minus-circle text-danger me-2"></i>
                                            {% endif %}
                                            <div>
                                                <h6 class="mb-1">{{ transaction.description }}</h6>
                                                <small class="text-muted">
                                                    <i class="fas fa-clock me-1"></i>{{ transaction.date }}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="transaction-amount text-end">
                                        {% if transaction.amount > 0 %}
                                            <span class="badge bg-success fs-6">+{{ transaction.amount }} 币</span>
                                        {% else %}
                                            <span class="badge bg-danger fs-6">{{ transaction.amount }} 币</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-receipt text-muted" style="font-size: 3rem;"></i>
                            <h5 class="mt-3 text-muted">暂无交易记录</h5>
                            <p class="text-muted">开始使用宝宝币吧！</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>关闭
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 购物车数据
let cart = [];
let dishesData = {{ dishes | tojson | safe }};
let currentBalance = {{ user_data.balance or 0 }};
let userCoupons = {{ user_data.coupons | tojson | safe }};
let selectedCoupon = null;

// 添加到购物车
function addToCart(dishName, dishIndex, price) {
    cart.push({
        name: dishName,
        price: price
    });
    updateCartDisplay();
    
    // 添加视觉反馈
    const dishCard = document.querySelector(`[data-dish-index="${dishIndex}"]`);
    dishCard.classList.add('dish-added');
    setTimeout(() => {
        dishCard.classList.remove('dish-added');
    }, 1000);
    
    // 显示提示
    showToast(`已将 "${dishName}" (${price}宝宝币) 加入购物车`, 'success');
}

// 计算总费用
function getTotalCost() {
    return cart.reduce((total, item) => total + item.price, 0);
}

// 从购物车移除
function removeFromCart(index) {
    const removedItem = cart[index];
    cart.splice(index, 1);
    updateCartDisplay();
    showToast(`已从购物车移除 "${removedItem.name}"`, 'info');
}

// 更新购物车显示
function updateCartDisplay() {
    const cartItemsContainer = document.getElementById('cartItems');
    const cartSummary = document.getElementById('cartSummary');
    const cartCount = document.getElementById('cartCount');
    const checkoutBtn = document.getElementById('checkoutBtn');
    
    cartCount.textContent = cart.length;
    
    if (cart.length === 0) {
        cartItemsContainer.innerHTML = `
            <div class="empty-cart text-center py-4">
                <i class="fas fa-shopping-cart text-muted" style="font-size: 2rem;"></i>
                <p class="mt-2 text-muted">购物车为空<br>选择您喜欢的菜品吧！</p>
            </div>
        `;
        cartSummary.style.display = 'none';
        checkoutBtn.disabled = true;
        return;
    }
    
    // 统计菜品数量
    const dishCounts = {};
    cart.forEach(item => {
        if (dishCounts[item.name]) {
            dishCounts[item.name].count++;
            dishCounts[item.name].totalPrice += item.price;
        } else {
            dishCounts[item.name] = {
                count: 1,
                price: item.price,
                totalPrice: item.price
            };
        }
    });
    
    let html = '';
    cart.forEach((item, index) => {
        html += `
            <div class="cart-item d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                <span class="flex-grow-1">${index + 1}. ${item.name}</span>
                <span class="text-warning me-2">${item.price}币</span>
                <button class="btn btn-outline-danger btn-sm" onclick="removeFromCart(${index})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
    });
    
    cartItemsContainer.innerHTML = html;
    
    const totalCost = getTotalCost();
    
    // 更新统计信息
    document.getElementById('totalItems').textContent = cart.length;
    document.getElementById('uniqueItems').textContent = Object.keys(dishCounts).length;
    
    // 添加总费用显示
    if (!document.getElementById('totalCost')) {
        cartSummary.innerHTML += `
            <div class="d-flex justify-content-between">
                <span>总费用：</span>
                <span id="totalCost" class="text-warning fw-bold">${totalCost} 宝宝币</span>
            </div>
        `;
    } else {
        document.getElementById('totalCost').textContent = `${totalCost} 宝宝币`;
    }
    
    cartSummary.style.display = 'block';
    checkoutBtn.disabled = false; // 始终允许用户点击下单按钮
    
    // 更新按钮显示文本，但不禁用
    if (totalCost > currentBalance) {
        checkoutBtn.innerHTML = `
            <i class="fas fa-exclamation-triangle me-2"></i>确认下单 (余额不足)
        `;
        checkoutBtn.classList.remove('btn-success');
        checkoutBtn.classList.add('btn-warning'); // 使用警告色而不是危险色
    } else {
        checkoutBtn.innerHTML = `
            <i class="fas fa-check me-2"></i>确认下单
        `;
        checkoutBtn.classList.remove('btn-warning');
        checkoutBtn.classList.add('btn-success');
    }
}

// 清空购物车
function clearCart() {
    if (cart.length === 0) {
        showToast('购物车已经是空的', 'info');
        return;
    }
    
    if (confirm('确定要清空购物车吗？')) {
        cart = [];
        updateCartDisplay();
        showToast('购物车已清空', 'info');
    }
}

// 随机推荐
function randomRecommend() {
    if (dishesData.length === 0) {
        showToast('暂无菜品可推荐', 'warning');
        return;
    }
    
    const randomDish = dishesData[Math.floor(Math.random() * dishesData.length)];
    const dishIndex = dishesData.indexOf(randomDish);
    
    // 滚动到推荐的菜品
    const dishCard = document.querySelector(`[data-dish-index="${dishIndex}"]`);
    if (dishCard) {
        dishCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // 高亮推荐的菜品
        dishCard.classList.add('dish-recommended');
        setTimeout(() => {
            dishCard.classList.remove('dish-recommended');
        }, 3000);
    }
    
    showToast(`为您推荐: ${randomDish.name}`, 'info');
}

// 更新订单模态框
function updateOrderModal() {
    const orderSummary = document.getElementById('orderSummary');
    
    if (cart.length === 0) {
        orderSummary.innerHTML = '<p class="text-muted">购物车为空</p>';
        updateCouponSection();
        return;
    }
    
    // 统计菜品数量
    const dishCounts = {};
    cart.forEach(item => {
        if (dishCounts[item.name]) {
            dishCounts[item.name].count++;
            dishCounts[item.name].totalPrice += item.price;
        } else {
            dishCounts[item.name] = {
                count: 1,
                price: item.price,
                totalPrice: item.price
            };
        }
    });
    
    let html = '<ul class="list-unstyled mb-0">';
    Object.entries(dishCounts).forEach(([dishName, data]) => {
        html += `
            <li class="d-flex justify-content-between align-items-center mb-1">
                <span>${dishName}</span>
                <span>
                    <span class="badge bg-primary me-2">${data.count}</span>
                    <span class="text-warning">${data.totalPrice}宝宝币</span>
                </span>
            </li>
        `;
    });
    html += '</ul>';
    
    const originalCost = getTotalCost();
    const {finalCost, discount} = calculateFinalCost(originalCost);
    
    html += `
        <div class="mt-3 pt-2 border-top">
            <div class="d-flex justify-content-between">
                <strong>总计: ${cart.length} 道菜</strong>
                <strong class="text-warning">${originalCost} 宝宝币</strong>
            </div>`;
    
    if (selectedCoupon) {
        html += `
            <div class="d-flex justify-content-between text-success">
                <span>优惠券折扣:</span>
                <span>-${originalCost - finalCost} 宝宝币</span>
            </div>
            <div class="d-flex justify-content-between text-success">
                <strong>实付金额:</strong>
                <strong>${finalCost} 宝宝币</strong>
            </div>`;
    }
    
    html += `
            <div class="d-flex justify-content-between text-muted">
                <span>当前余额:</span>
                <span>${currentBalance} 宝宝币</span>
            </div>
            <div class="d-flex justify-content-between">
                <span>支付后余额:</span>
                <span class="${finalCost > currentBalance ? 'text-danger' : 'text-success'}">${currentBalance - finalCost} 宝宝币</span>
            </div>
        </div>
    `;
    
    orderSummary.innerHTML = html;
    updateCouponSection();
}

// 优惠券相关功能
function updateCouponSection() {
    const couponList = document.getElementById('couponList');
    
    // 过滤可用的优惠券
    const availableCoupons = userCoupons.filter(coupon => 
        !coupon.used && new Date(coupon.expires) > new Date()
    );
    
    if (availableCoupons.length === 0) {
        couponList.innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-ticket-alt me-2"></i>暂无可用优惠券
                <p class="mb-0 mt-1 small">通过每日签到获得优惠券</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    availableCoupons.forEach(coupon => {
        const isSelected = selectedCoupon && selectedCoupon.id === coupon.id;
        html += `
            <div class="coupon-item ${isSelected ? 'selected' : ''}" onclick="selectCoupon('${coupon.id}')">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center">
                            <div class="coupon-icon me-2">
                                ${coupon.type === 'discount' ? '<i class="fas fa-percentage"></i>' : '<i class="fas fa-gift"></i>'}
                            </div>
                            <div>
                                <strong>${coupon.description}</strong>
                                <br><small class="text-muted">有效期至: ${coupon.expires}</small>
                            </div>
                        </div>
                    </div>
                    <div class="coupon-value">
                        ${coupon.type === 'discount' ? Math.round(coupon.value * 100) + '折' : '免单'}
                    </div>
                    <div class="coupon-radio">
                        <i class="fas fa-${isSelected ? 'check-circle text-success' : 'circle text-muted'}"></i>
                    </div>
                </div>
            </div>
        `;
    });
    
    // 添加"不使用优惠券"选项
    const noSelectSelected = !selectedCoupon;
    html += `
        <div class="coupon-item ${noSelectSelected ? 'selected' : ''}" onclick="selectCoupon(null)">
            <div class="d-flex justify-content-between align-items-center">
                <div class="flex-grow-1">
                    <strong>不使用优惠券</strong>
                </div>
                <div class="coupon-radio">
                    <i class="fas fa-${noSelectSelected ? 'check-circle text-success' : 'circle text-muted'}"></i>
                </div>
            </div>
        </div>
    `;
    
    couponList.innerHTML = html;
}

function selectCoupon(couponId) {
    if (couponId === null) {
        selectedCoupon = null;
    } else {
        selectedCoupon = userCoupons.find(c => c.id === couponId);
    }
    updateOrderModal(); // 重新更新订单摘要
}

function calculateFinalCost(originalCost) {
    if (!selectedCoupon) {
        return {finalCost: originalCost, discount: 0};
    }
    
    if (selectedCoupon.type === 'free') {
        return {finalCost: 0, discount: originalCost};
    } else if (selectedCoupon.type === 'discount') {
        const finalCost = Math.ceil(originalCost * selectedCoupon.value);
        const discount = originalCost - finalCost;
        return {finalCost, discount};
    }
    
    return {finalCost: originalCost, discount: 0};
}

// 提交订单
function submitOrder() {
    if (cart.length === 0) {
        showToast('购物车为空，无法下单', 'warning');
        return;
    }
    
    const originalCost = getTotalCost();
    const {finalCost, discount} = calculateFinalCost(originalCost);
    
    if (finalCost > currentBalance) {
        showToast(`余额不足！需要 ${finalCost} 宝宝币，但您只有 ${currentBalance} 宝宝币`, 'error');
        return;
    }
    
    const customerName = document.getElementById('customerName').value.trim() || '匿名客户';
    const customerId = '{{ customer_id or "web" }}';
    
    const orderData = {
        customer_name: customerName,
        customer_id: customerId,
        selected_dishes: cart.map(item => item.name),
        original_cost: originalCost,
        final_cost: finalCost,
        discount: discount,
        coupon_id: selectedCoupon ? selectedCoupon.id : null
    };
    
    fetch('/place_order', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(orderData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 更新本地余额
            currentBalance = data.new_balance;
            document.getElementById('userBalance').textContent = currentBalance;
            
            // 如果使用了优惠券，标记为已使用
            if (selectedCoupon) {
                const couponIndex = userCoupons.findIndex(c => c.id === selectedCoupon.id);
                if (couponIndex !== -1) {
                    userCoupons[couponIndex].used = true;
                }
                selectedCoupon = null; // 重置选择的优惠券
            }
            
            // 关闭下单模态框
            const orderModal = bootstrap.Modal.getInstance(document.getElementById('orderModal'));
            orderModal.hide();
            
            // 显示成功信息
            let successMessage = `<strong>订单号: #${data.order_id}</strong><br>`;
            if (data.discount_applied && data.discount_applied > 0) {
                successMessage += `<small class="text-success">使用优惠券节省: ${data.discount_applied} 宝宝币</small><br>`;
                successMessage += `<small class="text-muted">实付: ${data.final_cost} 宝宝币，余额: ${currentBalance} 宝宝币</small>`;
            } else {
                successMessage += `<small class="text-muted">消费: ${data.total_cost} 宝宝币，余额: ${currentBalance} 宝宝币</small>`;
            }
            
            document.getElementById('orderIdDisplay').innerHTML = successMessage;
            
            const successModal = new bootstrap.Modal(document.getElementById('successModal'));
            successModal.show();
            
            // 清空购物车
            cart = [];
            updateCartDisplay();
            
        } else {
            showToast(data.message || '下单失败', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('下单失败，请重试', 'error');
    });
}

// 显示提示消息
function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer') || createToastContainer();
    
    const toastId = 'toast_' + Date.now();
    const toastHtml = `
        <div id="${toastId}" class="toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
    
    // 自动删除DOM元素
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}

// 创建Toast容器
function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toastContainer';
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '9999';
    document.body.appendChild(container);
    return container;
}

// 计算交易统计
function calculateTransactionStats() {
    const transactions = {{ user_data.transactions | tojson | safe }};
    let totalIncome = 0;
    let totalExpense = 0;
    
    transactions.forEach(transaction => {
        if (transaction.amount > 0) {
            totalIncome += transaction.amount;
        } else {
            totalExpense += Math.abs(transaction.amount);
        }
    });
    
    // 更新模态框中的统计信息
    const totalIncomeElement = document.getElementById('totalIncome');
    const totalExpenseElement = document.getElementById('totalExpense');
    
    if (totalIncomeElement) {
        totalIncomeElement.textContent = totalIncome + ' 币';
    }
    if (totalExpenseElement) {
        totalExpenseElement.textContent = totalExpense + ' 币';
    }
}

// 页面加载完成后的初始化
$(document).ready(function() {
    updateCartDisplay();
    calculateTransactionStats();
    
    // 当打开订单模态框时更新订单详情
    document.getElementById('orderModal').addEventListener('show.bs.modal', updateOrderModal);
    
    // 当打开交易模态框时更新统计
    document.getElementById('transactionModal').addEventListener('show.bs.modal', calculateTransactionStats);
});
</script>

<style>
/* 页面背景样式 */
.customer-dashboard {
    min-height: 100vh;
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #f1f5f9 100%);
    padding: 1rem 0;
}

/* 提示框样式调整 */
.alert-info {
    background: rgba(255,255,255,0.9);
    border: 1px solid #bee5eb;
    color: #0c5460;
    border-radius: 15px;
    backdrop-filter: blur(10px);
}

/* 自定义样式 */
.dishes-gallery {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
}

.dish-item-hover {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    cursor: pointer;
}

.dish-item-hover:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
}

.dish-image {
    transition: transform 0.3s ease;
}

.dish-card {
    position: relative;
}

.dish-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 60px;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.dish-card:hover .dish-overlay {
    opacity: 1;
}

.dish-added {
    animation: addToCartPulse 0.6s ease;
}

.dish-recommended {
    animation: recommendPulse 3s ease infinite;
    box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.5) !important;
}

@keyframes addToCartPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

@keyframes recommendPulse {
    0%, 100% { box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.5); }
    50% { box-shadow: 0 0 0 6px rgba(255, 193, 7, 0.8); }
}

.cart-item {
    transition: all 0.3s ease;
}

.cart-item:hover {
    background-color: #f8f9fa !important;
}

.min-vh-75 {
    min-height: 75vh;
}

/* 优惠券样式 */
.coupon-item {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 12px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.coupon-item:hover {
    border-color: #007bff;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.coupon-item.selected {
    border-color: #28a745;
    background: #f8fff9;
}

.coupon-icon {
    width: 30px;
    height: 30px;
    background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #333;
}

.coupon-value {
    background: #007bff;
    color: white;
    padding: 4px 12px;
    border-radius: 15px;
    font-weight: bold;
    font-size: 0.9rem;
    margin-right: 10px;
}

.coupon-radio {
    font-size: 1.2rem;
}
</style>
{% endblock %}